@page "/my-animals"
@if (!Session.Context.IsAuthenticated)
{
    <MudAlert Severity="Severity.Error">Tienes que estar autenticado para acceder a tus animales</MudAlert>
}
@if(!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error" Elevation="0" Variant="Variant.Filled" Dense="true">
        @errorMessage
    </MudAlert>
}
else if (isLoading || Session.Context.IsLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Secondary" Size="MudBlazor.Size.Medium" StrokeWidth="6" />
}
else
{
    <MudText Typo="Typo.h3">Animales de @Session.Context.User.Name @Session.Context.User.SurName:</MudText>
    <MudDataGrid Items="@elements"
                 EditTrigger="DataGridEditTrigger.Manual"
                 Bordered="true"
                 Dense="true">
        <Columns>
            <PropertyColumn Property="x => x.Name" Title="Nombre" />
            <PropertyColumn Property="x => x.Species" Title="Especie">
                <EditTemplate>
                    <MudSelect @bind-Value="context.Item.Species" Required Margin="Margin.Dense">
                        <MudSelectItem Value="@("Perro")">Perro</MudSelectItem>
                        <MudSelectItem Value="@("Gato")">Gato</MudSelectItem>
                        <MudSelectItem Value="@("Conejo")">Conejo</MudSelectItem>
                        <MudSelectItem Value="@("Pájaro")">Pájaro</MudSelectItem>
                    </MudSelect>
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.BirthDate" Title="Fecha nac." />
            <PropertyColumn Property="x => x.AnimalState" Title="Estado">
                <EditTemplate>
                    <MudSelect @bind-Value="context.Item.AnimalState" Required Margin="Margin.Dense">
                        <MudSelectItem Value="@("Adoptado")">Adoptado</MudSelectItem>
                        <MudSelectItem Value="@("Disponible")">Disponible</MudSelectItem>
                    </MudSelect>
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Description" Title="Descripción" />
        </Columns>
    </MudDataGrid>
}


@code {
    private string? errorMessage = null;
    private bool isLoading = true;
    private List<AnimalDTO> elements = new();

    protected override async Task OnInitializedAsync()
    {
        if (!Session.Context.IsAuthenticated) return;
        var result = await ApiClientsFactory.UserClient().GetUserAnimalsAsync(Session.Context.User.Id);
        isLoading = false;
        if (!result.Success)
        {
            errorMessage = result.Message;
            return;
        }
        elements = result.Data!.ToList();
    }
}
