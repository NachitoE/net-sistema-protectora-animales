@page "/modify-medical-checkups"
@using DTOs
@using Helpers
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<h3>Modificar Registros Médicos</h3>

@if (!Session.IsAuthenticated || !(Session.Context.User.UserType == "Admin" || Session.Context.User.UserType == "Transito" || Session.Context.User.UserType == "Voluntario"))
{
    <p>No autorizado</p>
}
else if (isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Secondary" Size="MudBlazor.Size.Medium" StrokeWidth="6" />
}
else if (errorMessage != null)
{
    <div>ERROR: @errorMessage</div>
}
else
{
    <MudDataGrid T="MedicalCheckUpDTO"
                 Items="@elements"
                 ReadOnly="false"
                 EditMode="DataGridEditMode.Form"
                 EditTrigger="DataGridEditTrigger.Manual"
                 CommittedItemChanges="OnCommittedItemChanges"
                 Bordered="true"
                 Dense="true">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" Editable="false" />
            <TemplateColumn Title="Animal" Editable="false">
                <CellTemplate>
                    <AnimalTooltip AnimalId="@context.Item.AnimalId" />
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.CheckUpDate" Title="Fecha de Chequeo" />
            <PropertyColumn Property="x => x.Observation" Title="Observación" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Size="Size.Small"
                                   Icon="@Icons.Material.Outlined.Edit"
                                   OnClick="@context.Actions.StartEditingItemAsync" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private List<MedicalCheckUpDTO> elements = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = Session.Context.User;
            var medicalClient = ApiClientsFactory.MedicalCheckUpClient();
            var userClient = ApiClientsFactory.UserClient();

            var medicalResult = await medicalClient.GetAllAsync();
            if (!medicalResult.Success || medicalResult.Data == null)
            {
                errorMessage = medicalResult.Message ?? "Error al cargar los chequeos médicos.";
                return;
            }

            var allCheckups = medicalResult.Data.ToList();


            if (user.UserType == "Admin")
            {
                elements = allCheckups;
            }
            else
            {
               
                var userAnimalsResult = await userClient.GetUserAnimalsAsync(user.Id);
                if (!userAnimalsResult.Success || userAnimalsResult.Data == null)
                {
                    Snackbar.Add("No se pudieron obtener los animales a cargo del usuario.", Severity.Warning);
                    elements = new();
                }
                else
                {
                    var caretakerAnimalIds = userAnimalsResult.Data.Select(a => a.Id).ToHashSet();
                    elements = allCheckups
                        .Where(mc => caretakerAnimalIds.Contains(mc.AnimalId))
                        .ToList();
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnCommittedItemChanges(MedicalCheckUpDTO medicalCheck)
    {
        var client = ApiClientsFactory.MedicalCheckUpClient();
        var result = await client.PutAsync(medicalCheck.Id, medicalCheck);

        if (!result.Success)
        {
            Snackbar.Add($"Error al actualizar el registro médico: {result.Message}", Severity.Error);
            await ReloadData();
            return;
        }

        Snackbar.Add("Registro médico actualizado correctamente", Severity.Success);
    }

    private async Task ReloadData()
    {
        isLoading = true;
        StateHasChanged();
        await OnInitializedAsync();
    }
}