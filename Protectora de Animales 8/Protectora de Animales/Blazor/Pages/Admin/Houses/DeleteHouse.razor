@page "/delete-houses"
@inject ISnackbar Snackbar

<h3>Eliminar Casas</h3>

@if (!Session.IsAuthenticated || Session.Context.User.UserType != "Admin")
{
    <p>No autorizado</p>
}
else if (isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Secondary" Size="MudBlazor.Size.Medium" StrokeWidth="6" />
}
else if (errorMessage != null)
{
    <MudAlert Severity="Severity.Error">ERROR: @errorMessage</MudAlert>
}
else
{
    <MudDataGrid Items="@houses"
                 @bind-SelectedItem="selectedHouse"
                 SelectOnRowClick="true"
                 Hover="true"
                 Bordered="true"
                 Dense="true"
                 RowClassFunc="@GetRowClass"
                 RowClass="pointer">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="ID" />
            <PropertyColumn Property="x => x.Address" Title="Dirección" />
            <PropertyColumn Property="x => x.AddressNumber" Title="Número" />
            <PropertyColumn Property="x => x.Capacity" Title="Capacidad" />
            <TemplateColumn Title="Usuario">
                <CellTemplate>
                    <UserTooltip UserId="@context.Item.UserId" />
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Acciones">
                <CellTemplate>
                    <MudButton OnClick="@(() => DeleteItem(context.Item))" 
                               Disabled="@isDeleting" 
                               Color="Color.Error" 
                               Variant="Variant.Filled" 
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Delete">
                        Eliminar
                    </MudButton>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    @if (selectedHouse != null)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudText Typo="Typo.h6">Casa seleccionada: @selectedHouse.Address @selectedHouse.AddressNumber (@selectedHouse.Id)</MudText>
            <MudButton OnClick="@DeleteSelectedItem" 
                       Disabled="@isDeleting" 
                       Class="mt-2"
                       Variant="Variant.Filled" 
                       Color="Color.Error"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Delete">
                @if (isDeleting)
                {
                    <MudProgressCircular Class="ms-n1" Size="MudBlazor.Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Eliminando...</MudText>
                }
                else
                {
                    <MudText>Eliminar Seleccionado</MudText>
                }
            </MudButton>
        </MudPaper>
    }
}

@code {
    private bool isLoading = true;
    private bool isDeleting = false;
    private string? errorMessage = null;
    private List<HouseDTO> houses = new();
    private HouseDTO? selectedHouse = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadHouses();
    }

    private async Task LoadHouses()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var houseClient = ApiClientsFactory.HouseClient();
            var result = await houseClient.GetAllAsync();

            if (!result.Success || result.Data == null)
            {
                errorMessage = result.Message ?? "Error al cargar las casas";
                return;
            }

            houses = result.Data;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DeleteItem(HouseDTO house)
    {
        if (isDeleting) return;

        try
        {
            isDeleting = true;
            StateHasChanged();

            var houseClient = ApiClientsFactory.HouseClient();
            var result = await houseClient.DeleteAsync(house.Id);

            if (!result.Success)
            {
                Snackbar.Add(result.Message ?? "Error al eliminar la casa", Severity.Error);
                return;
            }

            Snackbar.Add("Casa eliminada correctamente", Severity.Success);
            await LoadHouses();
            selectedHouse = null;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error inesperado: {ex.Message}", Severity.Error);
        }
        finally
        {
            isDeleting = false;
        }
    }

    private async Task DeleteSelectedItem()
    {
        if (selectedHouse != null)
        {
            await DeleteItem(selectedHouse);
        }
    }

    private string GetRowClass(HouseDTO? house, int index)
        => selectedHouse?.Id == house?.Id ? "selected-row" : string.Empty;
}