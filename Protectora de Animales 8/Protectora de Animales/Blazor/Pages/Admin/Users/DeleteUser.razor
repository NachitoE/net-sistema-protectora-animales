@page "/delete-users"
@inject ISnackbar Snackbar

<h3>Eliminar Usuarios</h3>

@if (!Session.IsAuthenticated || Session.Context.User.UserType != "Admin")
{
    <p>No autorizado</p>
}
else if (isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Secondary" Size="MudBlazor.Size.Medium" StrokeWidth="6" />
}
else if (errorMessage != null)
{
    <MudAlert Severity="Severity.Error">ERROR: @errorMessage</MudAlert>
}
else
{
    <MudDataGrid Items="@users"
                 @bind-SelectedItem="selectedUser"
                 SelectOnRowClick="true"
                 Hover="true"
                 Bordered="true"
                 Dense="true"
                 RowClassFunc="@GetRowClass"
                 RowClass="pointer">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="ID" />
            <PropertyColumn Property="x => x.Name" Title="Nombre" />
            <PropertyColumn Property="x => x.SurName" Title="Apellido" />
            <PropertyColumn Property="x => x.UserName" Title="Usuario" />
            <PropertyColumn Property="x => x.DNI" Title="DNI" />
            <PropertyColumn Property="x => x.UserType" Title="Tipo" />
            <TemplateColumn Title="Acciones">
                <CellTemplate>
                    <MudButton OnClick="@(() => DeleteItem(context.Item))" 
                               Disabled="@isDeleting" 
                               Color="Color.Error" 
                               Variant="Variant.Filled" 
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Delete">
                        Eliminar
                    </MudButton>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>

    @if (selectedUser != null)
    {
        <MudPaper Class="pa-4 mt-4">
            <MudText Typo="Typo.h6">Usuario seleccionado: @selectedUser.UserName (@selectedUser.Id)</MudText>
            <MudButton OnClick="@DeleteSelectedItem" 
                       Disabled="@isDeleting" 
                       Class="mt-2"
                       Variant="Variant.Filled" 
                       Color="Color.Error"
                       FullWidth="true"
                       StartIcon="@Icons.Material.Filled.Delete">
                @if (isDeleting)
                {
                    <MudProgressCircular Class="ms-n1" Size="MudBlazor.Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Eliminando...</MudText>
                }
                else
                {
                    <MudText>Eliminar Seleccionado</MudText>
                }
            </MudButton>
        </MudPaper>
    }
}

@code {
    private bool isLoading = true;
    private bool isDeleting = false;
    private string? errorMessage = null;
    private List<UserDTO> users = new();
    private UserDTO? selectedUser = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var userClient = ApiClientsFactory.UserClient();
            var result = await userClient.GetAllAsync();

            if (!result.Success || result.Data == null)
            {
                errorMessage = result.Message ?? "Error al cargar los usuarios";
                return;
            }

            users = result.Data;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DeleteItem(UserDTO user)
    {
        if (isDeleting) return;

        try
        {
            isDeleting = true;
            StateHasChanged();

            var userClient = ApiClientsFactory.UserClient();
            var result = await userClient.DeleteAsync(user.Id);

            if (!result.Success)
            {
                Snackbar.Add(result.Message ?? "Error al eliminar el usuario", Severity.Error);
                return;
            }

            Snackbar.Add("Usuario eliminado correctamente", Severity.Success);
            await LoadUsers();
            selectedUser = null;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error inesperado: {ex.Message}", Severity.Error);
        }
        finally
        {
            isDeleting = false;
        }
    }

    private async Task DeleteSelectedItem()
    {
        if (selectedUser != null)
        {
            await DeleteItem(selectedUser);
        }
    }

    private string GetRowClass(UserDTO? user, int index)
        => selectedUser?.Id == user?.Id ? "selected-row" : string.Empty;
}