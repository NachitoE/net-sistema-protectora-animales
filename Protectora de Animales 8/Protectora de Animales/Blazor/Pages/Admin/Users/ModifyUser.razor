@page "/modify-users"
@using DTOs.House
@using Helpers;
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<h3>Modificar Usuarios</h3>
@if (!Session.IsAuthenticated || Session.Context.User.UserType != "Admin")
{
    <p>No autorizado</p>
}
else if (isLoading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Secondary" Size="MudBlazor.Size.Medium" StrokeWidth="6" />
}
else if (errorMessage != null)
{
    <div>ERROR: @errorMessage</div>
}
else
{
    <MudDataGrid Items="@elements"
                 ReadOnly="false"
                 EditMode="DataGridEditMode.Form"
                 CommittedItemChanges="@OnCommittedItemChangesHandler"
                 EditTrigger="DataGridEditTrigger.Manual"
                 Bordered="true"
                 Dense="true">
        <Columns>
            <PropertyColumn Editable="false" Property="x => x.Id" Title="Id" />
            <PropertyColumn Property="x => x.Name" Title="Nombre" />
            <PropertyColumn Property="x => x.SurName" Title="Apellido" />
            <PropertyColumn Property="x => x.UserName" Title="Usuario" />
            <PropertyColumn Property="x => x.UserType" Title="Tipo">
                <EditTemplate>
                    <MudSelect @bind-Value="context.Item.UserType" Required Margin="Margin.Dense">
                        <MudSelectItem Value="@("Admin")">Admin</MudSelectItem>
                        <MudSelectItem Value="@("Voluntario")">Voluntario</MudSelectItem>
                        <MudSelectItem Value="@("Transito")">Tránsito</MudSelectItem>
                        <MudSelectItem Value="@("Adoptante")">Adoptante</MudSelectItem>
                    </MudSelect>
                </EditTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.DNI" Title="DNI" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
}

@code {
    private bool isLoading = true;
    private string? errorMessage = null;
    private List<UserDTO> elements = new();

    protected override async Task OnInitializedAsync()
    {
        var result = await ApiClientsFactory.UserClient().GetAllAsync();
        isLoading = false;
        if (!result.Success)
        {
            errorMessage = result.Message;
            return;
        }
        elements = result.Data!.ToList();
    }

    private async Task OnCommittedItemChanges(UserDTO user)
    {
        //es transito? houseload form
        if (user.UserType == EnumConversion.UserTypeToString(Domain.UserType.Transito))
        {
            var houseClient = ApiClientsFactory.HouseClient();
            var userClient = ApiClientsFactory.UserClient();

            var existingHouseResult = await houseClient.GetHouseByUserId(user.Id);
            var userAnimals = await userClient.GetUserAnimalsAsync(user.Id);
            int userAnimalsCount = userAnimals.Data.Count();
            bool canUserAllocateAnimals = true;
            bool hasHouse = existingHouseResult.Success && existingHouseResult.Data != null;
            //si tiene 0 animales, nunca va a entrar acá
            if (hasHouse && userAnimals.Success)
            {
                canUserAllocateAnimals = userAnimalsCount < existingHouseResult.Data.Capacity;
            }

            //ya tiene casa asignada y puede alojar animales, usamos esa casa
            if (hasHouse && canUserAllocateAnimals)
            {
                Snackbar.Add($"El usuario {user.UserName} ya tiene una casa asignada", Severity.Info);
            }
            else //no tiene casa asignada o su casa no cumple con las condiciones, se la cargamos
            {
                var parameters = new DialogParameters { ["UserId"] = user.Id, ["MinimumCapacity"] = userAnimalsCount };
                var dialog = await DialogService.ShowAsync<HouseLoadDialog>("Asignar Casa", parameters);
                var result = await dialog.Result;

                if (result.Canceled || result.Data == null)
                {
                    Snackbar.Add($"Algo mal salió en la carga de la casa", Severity.Error);
                    return;
                }
                HouseRegisterRequestDTO houseRegReqDTO = (HouseRegisterRequestDTO)result.Data;
                if (userAnimalsCount < houseRegReqDTO.Capacity)
                {
                   //aaa 
                }
                ApiResult<HouseDTO> loadHouseResult = default;
                if (hasHouse)
                {
                    //actualizamos la casa existente
                    HouseDTO houseDTO = new()
                        {
                            Address = houseRegReqDTO.Address,
                            AddressNumber = houseRegReqDTO.AddressNumber,
                            Capacity = houseRegReqDTO.Capacity
                        };
                    loadHouseResult = await houseClient.PutAsync(existingHouseResult.Data.Id, houseDTO);
                }
                else
                {
                    //creamos una nueva casa
                    loadHouseResult = await houseClient.PostAsync(houseRegReqDTO);
                }
                if (!loadHouseResult.Success)
                {
                    Snackbar.Add($"Error: {loadHouseResult.Message}", Severity.Error);
                    return;
                }

                Snackbar.Add($"Casa {loadHouseResult.Data.Address} {loadHouseResult.Data.AddressNumber} asignada a {user.UserName}", Severity.Success);
            }
        }
        //continue normal user update
        var updateResult = await ApiClientsFactory.UserClient().PutAsync(user.Id, user);
        if (!updateResult.Success)
        {
            Snackbar.Add($"Error: {updateResult.Message}", Severity.Error);
            return;
        }
        var updatedUser = updateResult.Data;
        if (updatedUser == null)
        {
            Snackbar.Add($"Usuario {user.UserName} parece haber sido actualizado, pero algo pudo haber ocurrido", Severity.Warning);
            return;
        }
        Snackbar.Add($"Usuario {updatedUser.UserName} actualizado", Severity.Success);
        

    }

    private EventCallback<UserDTO> OnCommittedItemChangesHandler =>
        EventCallback.Factory.Create<UserDTO>(this, OnCommittedItemChanges);
}